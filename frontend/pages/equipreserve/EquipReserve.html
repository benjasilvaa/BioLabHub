<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EquipReserve | BIOLABHUB</title>
  <link rel="icon" href="{{ url_for('static', filename='assets/LOGO-SOLO.ico') }}" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', filename='equipreserve/EquipReserve.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar">
    <div class="logo-container">
      <img src="{{ url_for('static', filename='assets/BioLabHub (negro).png') }}">
    </div>
    <div class="user-avatar">
      <span> {{ session['nombre'] }}</span>
      <a href="{{ url_for('login_bp.logout') }}" class="logout-btn">Cerrar sesión</a>
    </div>
  </nav>

  <div class="content">
    <div class="sidebar">
      <nav>
        <a href="{{ url_for('home_bp.home') }}">Inicio</a>
        <a href="{{ url_for('samples_bp.samples') }}">SampleTrack</a>
        <a href="{{ url_for('experiments_bp.experiments') }}">Experiment Planner</a>
        <a href="{{ url_for('reagents') }}">ReagentVault</a>
        <a href="{{ url_for('equipments_bp.equipreserve') }}" class="active">EquipReserve</a>

        {% if session.get("rol") == "admin" %}
        <a href="{{ url_for('admin_bp.admin_panel') }}" style="color: #ffcc00; font-weight: bold;">
           Panel Admin
        </a>
        {% endif %}
      </nav>
    </div>

    <div class="main">
      <h1>EquipReserve – Reservas de Equipos</h1>

      {% with mensajes = get_flashed_messages(with_categories=true) %}
        {% if mensajes %}
          {% for categoria, mensaje in mensajes %}
            <div class="alerta {{ categoria }}">{{ mensaje }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form class="form-nuevo" method="POST" action="{{ url_for('equipments_bp.add_reserva') }}">
        <h2> Nueva Reserva</h2>

        <label>Equipo:</label>
        <select name="equipo" required>
          <option value="">-- Selecciona un equipo --</option>
          {% for e in equipos %}
            <option value="{{ e['nombre'] }}">{{ e['nombre'] }}</option>
          {% endfor %}
        </select>

        <label>Inicio:</label>
        <input type="datetime-local" name="fecha_inicio" required>

        <label>Fin:</label>
        <input type="datetime-local" name="fecha_fin" required>

        <button type="submit">Reservar equipo</button>
      </form>

      <h2>Calendario</h2>
      <div id="calendar"></div>

      <div id="eventos" class="eventos"></div>
    </div>
  </div>
  <div id="modalEditar" class="modal" style="display:none;">
    <div class="modal-content">
      <h3> Editar Reserva</h3>

      <form id="formEditar" method="POST">
        <label>Equipo:</label>
        <input id="editar_equipo" type="text" name="equipo" required>

        <label>Inicio:</label>
        <input id="editar_inicio" type="datetime-local" name="fecha_inicio" required>

        <label>Fin:</label>
        <input id="editar_fin" type="datetime-local" name="fecha_fin" required>

        <button type="submit">Guardar cambios</button>
        <button type="button" onclick="cerrarModal()" class="cancel">Cancelar</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');

      window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 650,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },

        events: "{{ url_for('equipments_bp.equipreserve_events') }}",

        eventDidMount: function(info) {

          const userId = "{{ session['usuario_id'] }}";
          const userRol = "{{ session['rol'] }}";
          const creador = info.event.extendedProps.usuario_id;
          const rid = info.event.extendedProps.rid;

          if (userRol === "admin" || creador == userId) {
            let buttons = document.createElement("div");
            buttons.innerHTML = `
              <button class="edit-btn" onclick="editarReserva('${ rid }')"></button>
              <button class="delete-btn" onclick="eliminarReserva('${ rid }')"></button>
            `;
            buttons.classList.add("event-buttons");
            info.el.appendChild(buttons);
          }
        }   

      });

      window.calendar.render();
    });

    function eliminarReserva(rid) {
      if (!confirm("¿Eliminar esta reserva?")) return;

      fetch(`/equipreserve/delete/${rid}`, { method: "POST" })
        .then(() => window.calendar.refetchEvents());
    }

    function editarReserva(rid) {
      fetch(`/equipreserve/get/${rid}`)
        .then(r => r.json())
        .then(data => {

          document.getElementById("editar_equipo").value = data.equipo;
          document.getElementById("editar_inicio").value = data.fecha_inicio;
          document.getElementById("editar_fin").value = data.fecha_fin;

          document.getElementById("formEditar").action = `/equipreserve/edit/${rid}`;
          abrirModal();
        });
    }

    function abrirModal() {
      document.getElementById("modalEditar").style.display = "flex";
    }

    function cerrarModal() {
      document.getElementById("modalEditar").style.display = "none";
    }
  </script>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="/static/socket.js"></script>

  <script>
    socket.on("refresh_calendar", (data) => {
      window.calendar.refetchEvents();
    });
  </script>

</body>
</html>
